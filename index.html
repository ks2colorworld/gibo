<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>기보 작성 및 공유</title>
</head>
<body style="background: #fff0db">

  <style>
    button {
      margin: 20px;
    }
    body {
      margin: 0;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(18, 1fr);
      grid-template-rows: repeat(18, 1fr);
      grid-column-gap: 0px;
      grid-row-gap: 0px;
      width: 360px;
      margin-left: 20px;
      margin-top: 20px;
    }
    .board div{
      width: 20px;
      height: 20px;
      border: 1px solid black;
      background: rgb(255, 180, 76);
    }
    .board2 {
      display: grid;
      grid-template-columns: repeat(19, 1fr);
      grid-template-rows: repeat(19, 1fr);
      grid-column-gap: 0px;
      grid-row-gap: 0px;
      width: 380px;
      position: absolute;
      top: 9px; left : 9px;
    }
    .board2 div{
      width: 20px;
      height: 20px;
      border: 1px solid transparent;
      background: rgb(255, 180, 76, 0.2);
      
      text-align: center; 
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center; 
    }
    .board2 div.b {
      background: black;
      border-radius: 50%;
      color: white;
    }
    .board2 div.w {
      background: white;
      border-radius: 50%;
      color: black;
    }
      
    .container {
      display: flex;
      gap: 60px;
    }

    .memo {
      margin-top: 10px; /* 추가된 부분 */
      margin-right: 10px;
    }

    .replyContainer {
      margin-left: 10px;
      margin-right: 10px;
    }
  </style>
  
<div class="container">
  <div class="board">
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div> <!--1-->
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    
  </div>


  <div class="board2">
   
    
  </div>


  <textarea class="memo" rows="4" cols="50">
백기사명: 
흑기사명: 
대국명칭: 
대국결과: 
대국날짜: 
기타사항: 
  </textarea>
</div>

  <button>리셋</button> <button onclick="redirectToGitHub()">문의하기(깃허브-이슈등록)</button>
  <script>
    
    // var arr = Array(19).fill(0).map(x => Array(19).fill(0))
    var arr = Array(19 * 19).fill([0,0])
    var blackCount = 0;
    var whiteCount = 0;
    var memoString = 
`백기사명: 
흑기사명: 
대국명칭: 
대국결과: 
대국날짜: 
기타사항: `;

    //로드시 url 가져오기 
    const urlParams = new URLSearchParams(window.location.search);
    let myParam = urlParams.get('a');
    // url에 뭐가 있으면
    if (myParam != null) {
      blackCount = 0;
      whiteCount = 0;
      let 저장된어레이 = JSON.parse(atob(myParam));
      arr = [...저장된어레이]
      // console.log(저장된어레이);

      for (let i = 0; i < 19 * 19; i++) {
        if (arr[i][0] === 0) {
        document.querySelector('.board2').insertAdjacentHTML('beforeend',`<div data-id="${i}" class="${arr[i][0]}"></div>`)
        continue;
        }
        document.querySelector('.board2').insertAdjacentHTML('beforeend',`<div data-id="${i}" class="${arr[i][0]}">${arr[i][1]}</div>`)
        if (arr[i][0] === 'b') {
          blackCount += 1;
        } else if (arr[i][0] === 'w') {
          whiteCount += 1;
        }
        // console.log(blackCount, whiteCount);
      }

      //url에 뭐가 없으면
    } else {
      for (let i = 0; i < 19 * 19; i++) {
        document.querySelector('.board2').insertAdjacentHTML('beforeend',`<div data-id="${i}"></div>`)
      }
    }

    let myParam2 = urlParams.get('b');
    console.log(myParam2);
    // url에 뭐가 있으면
    if (myParam2 !== 'null' && myParam2 != null) {
      let 저장된메모 = JSON.parse(customAtob(myParam2));
      console.log(저장된메모);
      document.querySelector('.memo').value = 저장된메모;
    } else {
      document.querySelector('.memo').value = memoString;
    }
    
    function customBtoa(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    function customAtob(str) {
      return decodeURIComponent(escape(atob(str)));
    }

    function redirectToGitHub() {
      // 문의하기 버튼 동작 코드
      window.open('https://github.com/ks2colorworld/gibo/issues', '_blank');
    }

    document.querySelector('.memo').addEventListener('input', function(e) {
      var memoValue = e.target.value;
      // console.log("Memo value changed:", memoValue);

      //save to url
      let save = myParam;
      //save to memo
      let save2 = customBtoa(JSON.stringify(memoValue));
      myParam2 = save2;
      window.history.pushState({}, null, '?b=' + save2 + '&a=' + save);
    });



    document.querySelector('.board2').addEventListener('click', function(e){

      // 0 -> b -> w -> 0 순서로 바뀜
      if (e.target != document.querySelector('.board2')){
        if (e.target.classList.contains('w')){
          // 백돌 숫자 확인 후 중간 숫자는 무시
          if (arr[e.target.dataset.id][1] !== whiteCount) {
            return;
          }
          e.target.classList.remove('w')
          whiteCount -= 1;
          e.target.innerHTML = '';
          arr[e.target.dataset.id] = [0,0];
        }
        else if (e.target.classList.contains('b')){
          // 흑돌 숫자 확인 후 중간 숫자는 무시
          if (arr[e.target.dataset.id][1] !== blackCount) {
            return;
          }
          e.target.classList.remove('b')
          blackCount -= 1;
          // 흑돌 백돌 자동 전환되므로 흑돌도 없어짐
          e.target.innerHTML = '';
          arr[e.target.dataset.id] = [0,0];
        } else {
          // 흑돌이 놓인 후 백돌 놓여짐
          if (whiteCount < blackCount) {
            e.target.classList.add('w')
            whiteCount += 1;
            e.target.innerHTML = whiteCount;
            arr[e.target.dataset.id] = ['w',whiteCount]
          }else{
            e.target.classList.add('b')
            blackCount += 1;
            e.target.innerHTML = blackCount;
            arr[e.target.dataset.id] = ['b',blackCount]
          }
        }

        //save to url
        let save = btoa(JSON.stringify(arr));
        myParam = save;
        //save to memo
        // let save2 = customBtoa(JSON.stringify(document.querySelector('.memo').value));
        let save2 = myParam2;
        window.history.pushState({}, null, '?a=' + save + '&b=' + save2);
        // window.history.pushState({}, null, '?b=' + save2);
        
      }
    })


    // reset
    document.querySelector('button').addEventListener('click', function(e){
      
      arr = Array(19 * 19).fill([0,0]);
      blackCount = 0;
      whiteCount = 0;
      document.querySelector('.board2').innerHTML = '';
      for (let i = 0; i < 19 * 19; i++) {
        document.querySelector('.board2').insertAdjacentHTML('beforeend',`<div data-id="${i}"></div>`)
      }
      document.querySelector('.memo').value = memoString;

      let save = btoa(JSON.stringify(arr));
      myParam = save;
        // window.history.pushState({}, null, '?a=' + save);
      let save2 = customBtoa(JSON.stringify(memoString));
      myParam2 = save2;
      // window.history.pushState({}, null, '?b=' + save2);
      console.log(memoString);
        window.history.pushState({}, null, '?a=' + save + '&b=' + save2);
    })
    


    // 뒤로가기 누를 때 url에 있는거 가져와서 또 그리기 
    window.addEventListener('popstate', function(event) {
      const urlParams = new URLSearchParams(window.location.search);
      const myParam = urlParams.get('a');
      // url에 뭐가 있으면
      if (myParam != null) {
        let 저장된어레이 = JSON.parse(atob(myParam));
        arr = [...저장된어레이]
        console.log(저장된어레이);
        document.querySelector('.board2').innerHTML = '';
        for (let i = 0; i < 19 * 19; i++) {
          document.querySelector('.board2').insertAdjacentHTML('beforeend',`<div data-id="${i}" class="${arr[i][0]}"></div>`)
        }

        //url에 뭐가 없으면
      } else {
        document.querySelector('.board2').innerHTML = '';
        for (let i = 0; i < 19 * 19; i++) {
          document.querySelector('.board2').insertAdjacentHTML('beforeend',`<div data-id="${i}"></div>`)
        }
      }
    })

  </script>
  <div class="replyContainer">
<script src="https://giscus.app/client.js"
        data-repo="ks2colorworld/gibo"
        data-repo-id="R_kgDOKugLAw"
        data-category="Announcements"
        data-category-id="DIC_kwDOKugLA84CbMGP"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="ko"
        crossorigin="anonymous"
        async>
</script>
</div>
</body>
</html>